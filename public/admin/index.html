<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
  </head>
  <body>
    <!-- Forward OAuth token to Decap; retry so we win any race -->
    <script>
      (function () {
        var KEY = 'decap-cms-oauth';

        function readToken() {
          try { return localStorage.getItem(KEY); } catch (e) { return null; }
        }
        function clearToken() {
          try { localStorage.removeItem(KEY); } catch (e) {}
        }
        function send(msg) {
          try { window.postMessage(msg, '*'); } catch (e) {}
        }

        // 1) If the token is already there, start a short resend loop
        function resendLoop() {
          var msg = readToken();
          if (!msg) return;
          var tries = 0, max = 30; // ~6s at 200ms
          var t = setInterval(function () {
            tries++;
            send(msg);
            if (tries >= max) {
              clearInterval(t);
              clearToken();
            }
          }, 200);
        }

        // 2) Also catch tokens added later (e.g., popup redirect placed it)
        window.addEventListener('storage', function (e) {
          if (e.key === KEY && e.newValue) {
            resendLoop();
          }
        });

        // Kick it off ASAP and again after load
        resendLoop();
        window.addEventListener('load', resendLoop);

        // Optional: ensure /api/auth opens as a popup
        window.addEventListener('DOMContentLoaded', function () {
          document.body.addEventListener('click', function (e) {
            var a = e.target && e.target.closest && e.target.closest('a[href="/api/auth"]');
            if (!a) return;
            e.preventDefault();
            window.open(a.href, 'oauth', 'width=600,height=700,noopener');
          });
        });
      })();
    </script>

    <!-- Decap CMS -->
    <script defer src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>
